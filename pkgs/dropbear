url=$mirror/dropbear-2013.56.tar.bz2

fetch() {
	wget -c $url -O src/dropbear-2013.56.tar.bz2
}

unpack() {
	pushd src
	[ -d dropbear-2013.56 ] || tar xjf dropbear-2013.56.tar.bz2
	popd
}

build() {
	pushd src/dropbear-2013.56
	CC=x86_64-linux-musl-gcc ./configure CFLAGS="-I$libcroot/include" \
		LDFLAGS="-static -L$libcroot/lib" --prefix=$root || return 1
	for i in UTMP WTMP PUTUTLINE PUTUTXLINE SYSLOG LASTLOG; do
		echo "#define DISABLE_$i" >> config.h
	done
	make SCPPROGRESS=1 PROGRAMS="dropbear dbclient scp dropbearkey" \
		prefix=$root sbindir=$root/bin -j$nprocs STATIC=1 || return 1
	popd
}

install() {
	pushd src/dropbear-2013.56
	make SCPPROGRESS=1 PROGRAMS="dropbear dbclient scp dropbearkey" prefix=$root \
		sbindir=$root/bin -j$nprocs install STATIC=1 || return 1
	pushd $root/bin
	ln -s dbclient ssh
	popd
	popd
	cp $top/stuff/dropbearkeys $root/etc
}
