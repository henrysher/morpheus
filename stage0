#!/bin/sh

# Export important variables for the build scripts
top=$(pwd)
root=$top/root
nprocs=4
mirror=http://dl.2f30.org/morpheus-pkgs
export top root nprocs mirror

./clean
mkdir -p src cross
. ./prepare-root

./build cross-scripts/musl-0.9.13

PATH=$top/cross/bin:$PATH
export PATH

# These are ordered
./build cross-scripts/libevent-2.0.21
./build cross-scripts/ncurses-5.9
./build cross-scripts/zlib-1.2.8
# ./build cross-scripts/libsigc++-2.3.1
# ./build cross-scripts/curl-7.32.0
# ./build cross-scripts/libtorrent-0.13.3

# Build stage0 packages
pkglist=$(ls pkgs)
for pkg in $pkglist; do
	./build pkgs/$pkg
done

# Strip all executables
find $root/bin -executable -type f -exec strip {} \; &>/dev/null

pushd $root
echo Creating ramdisk
find . | cpio --quiet -H newc -o | gzip -9 -n > ../morpheus.img
popd

echo OK!
