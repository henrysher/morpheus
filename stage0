#!/bin/sh

# Export important variables for the build scripts
top=$(pwd)
root=$top/root
mirror=http://dl.2f30.org/morpheus-pkgs
export top root mirror

# Create directory hierarchy
rm -rf $root src
mkdir -p src
mkdir -p $root/{bin,boot,dev,etc,svc,home,root,var,share,devel,sys,proc}
mkdir -p $root/dev/shm
mkdir -p $root/devel/{include,lib,src}
mkdir -p $root/share/man
pushd $root/
ln -s /bin sbin
popd

./build cross-scripts/musl-0.9.13

PATH=$top/cross/bin:$PATH
export PATH

# Build stage0 packages
pkglist=$(ls pkgs)
for pkg in $pkglist; do
	./build pkgs/$pkg
done

pushd $root
find . | cpio --quiet -H newc -o | gzip -9 -n > ../rootfs.img
popd

echo OK!
